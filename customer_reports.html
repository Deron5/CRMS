<!DOCTYPE html>
<html lang="en">

<head>
    <title>CRMS</title>
    <link rel="stylesheet" href="tailwind.css">
    <link rel="stylesheet" href="main.css">

<style>
    tbody>tr:hover{
        background-color: #e8e7f2;
    }
    th{
        white-space: nowrap;
    }
</style>

</head>

<body class="">

    <div class="relative h-screen grid grid-rows-1 main border-2 border-stone-100">
        <details open class="sidebar h-full relative p-2 border-r-2 border-indigo-200">
            <summary class="list-none min-w-[5.75rem] mb-5 text-violet-500 text-3xl pb-4  border-[#767b99] border-b-2">
                CRMS
            </summary>
            <div class="flex flex-col w-40 gap-6">
                <button class="bg-violet-400 hover:bg-[#8e72e1] text-white font-bold py-2 px-4 border border-slate-200 rounded relative" onclick="window.location.href='http://localhost:8080/index.html'">Home Page
                    <div class="absolute right-0 top-[.45rem]">
                        <svg viewBox="0 0 24 24" focusable="false" height="28" width="28" class="t0PEec">
                            <path d="M0 0h24v24H0z" fill="none"></path>
                            <path fill="white" d="M8.59,16.59L13.17,12L8.59,7.41L10,6l6,6l-6,6L8.59,16.59z"></path>
                        </svg>
                    </div>
                </button>
                <button class="bg-violet-400 hover:bg-[#8e72e1] text-white font-bold py-2 px-4 border border-slate-200 rounded relative" onclick="window.location.href='http://localhost:8080/customers.html'">Customer Page
                    <div class="absolute right-0 top-[.45rem]">
                        <svg viewBox="0 0 24 24" focusable="false" height="28" width="28" class="t0PEec">
                            <path d="M0 0h24v24H0z" fill="none"></path>
                            <path fill="white" d="M8.59,16.59L13.17,12L8.59,7.41L10,6l6,6l-6,6L8.59,16.59z"></path>
                        </svg>
                    </div>
                </button>

                <button class="bg-violet-400 hover:bg-[#8e72e1] text-white font-bold py-2 px-4 border border-slate-200 rounded relative" onclick="window.location.href='http://localhost:8080/vehicles.html'">Vehicles Page
                    <div class="absolute right-0 top-[.45rem]">
                        <svg viewBox="0 0 24 24" focusable="false" height="28" width="28" class="t0PEec">
                            <path d="M0 0h24v24H0z" fill="none"></path>
                            <path fill="white" d="M8.59,16.59L13.17,12L8.59,7.41L10,6l6,6l-6,6L8.59,16.59z"></path>
                        </svg>
                    </div>
                </button>
                <button class="bg-violet-400 hover:bg-[#8e72e1] text-white font-bold py-2 px-4 border border-slate-200 rounded relative" onclick="window.location.href='http://localhost:8080/rentals.html'">Rentals Page

                    <div class="absolute right-0 top-[.45rem]">
                        <svg viewBox="0 0 24 24" focusable="false" height="28" width="28" class="t0PEec">
                            <path d="M0 0h24v24H0z" fill="none"></path>
                            <path fill="white" d="M8.59,16.59L13.17,12L8.59,7.41L10,6l6,6l-6,6L8.59,16.59z"></path>
                        </svg>
                    </div>
                </button>

                <details open class="leftArw opts">
                    <summary class="bg-violet-400 hover:bg-[#8e72e1] text-white font-bold py-2 px-4 border border-b-0 border-slate-300 rounded list-none text-center">
                        Reports</summary>
                    <div class="flex flex-col bg-[#f2f2f8]">
                        <button class=" p-2 bg-[#fbfcff] text-gray-700 text-[15px] font-medium hover:bg-[#a78bfa9c] border-2 relative" onclick="window.location.href='http://localhost:8080/rentals_reports'">
                            Vehicle Rentals
                            <div class="absolute right-[-5px] top-[.35rem]">
                                <svg viewBox="0 0 24 24" focusable="false" height="28" width="28" class="t0PEec">
                                    <path d="M0 0h24v24H0z" fill="none"></path>
                                    <path fill="#404355" d="M8.59,16.59L13.17,12L8.59,7.41L10,6l6,6l-6,6L8.59,16.59z">
                                    </path>
                                </svg>
                            </div>
                        </button>
                        <button class=" p-2 bg-[#fbfcff] text-gray-700 text-[15px] font-medium hover:bg-[#a78bfa9c] border-2 border-t-0 relative" onclick="window.location.href='http://localhost:8080/customer_reports'">
                            Customer Rentals
                            <div class="absolute right-[-5px] top-[.35rem]">
                                <svg viewBox="0 0 24 24" focusable="false" height="28" width="28" class="t0PEec">
                                    <path d="M0 0h24v24H0z" fill="none"></path>
                                    <path fill="#404355" d="M8.59,16.59L13.17,12L8.59,7.41L10,6l6,6l-6,6L8.59,16.59z">
                                    </path>
                                </svg>
                            </div>
                        </button>
                        <button class=" p-2 bg-[#fbfcff] text-gray-700 text-[15px] font-medium hover:bg-[#a78bfa9c] border-2 border-t-0 relative" onclick="window.location.href='http://localhost:8080/rentals_reports'">
                            Rental History
                            <div class="absolute right-[-5px] top-[.35rem]">
                                <svg viewBox="0 0 24 24" focusable="false" height="28" width="28" class="t0PEec">
                                    <path d="M0 0h24v24H0z" fill="none"></path>
                                    <path fill="#404355" d="M8.59,16.59L13.17,12L8.59,7.41L10,6l6,6l-6,6L8.59,16.59z">
                                    </path>
                                </svg>
                            </div>
                        </button>
                        <button class=" p-2 bg-[#fbfcff] text-gray-700 text-[15px] font-medium hover:bg-[#a78bfa9c] border-2 border-t-0 relative" onclick="window.location.href='http://localhost:8080/availability_reports'">
                            Vehicle Availability
                            <div class="absolute right-[-5px] top-[.35rem]">
                                <svg viewBox="0 0 24 24" focusable="false" height="28" width="28" class="t0PEec">
                                    <path d="M0 0h24v24H0z" fill="none"></path>
                                    <path fill="#404355" d="M8.59,16.59L13.17,12L8.59,7.41L10,6l6,6l-6,6L8.59,16.59z">
                                    </path>
                                </svg>
                            </div>
                        </button>
                        <button class=" p-2 bg-[#fbfcff] text-gray-700 text-[15px] font-medium hover:bg-[#a78bfa9c] border-2 border-t-0 relative" onclick="window.location.href='http://localhost:8080/late_return_reports'">
                            Late Returns
                            <div class="absolute right-[-5px] top-[.35rem]">
                                <svg viewBox="0 0 24 24" focusable="false" height="28" width="28" class="t0PEec">
                                    <path d="M0 0h24v24H0z" fill="none"></path>
                                    <path fill="#404355" d="M8.59,16.59L13.17,12L8.59,7.41L10,6l6,6l-6,6L8.59,16.59z">
                                    </path>
                                </svg>
                            </div>
                        </button>
                        <button class=" p-2 bg-[#fbfcff] text-[#404355] text-[15px]  font-medium hover:bg-[#a78bfa9c]  border-2 border-t-0 relative" onclick="window.location.href='http://localhost:8080/turnover_reports'">
                            Vehicle Turnover
                            <div class="absolute right-[-5px] top-[.35rem]">
                                <svg viewBox="0 0 24 24" focusable="false" height="28" width="28" class="t0PEec">
                                    <path d="M0 0h24v24H0z" fill="none"></path>
                                    <path fill="#404355" d="M8.59,16.59L13.17,12L8.59,7.41L10,6l6,6l-6,6L8.59,16.59z">
                                    </path>
                                </svg>
                            </div>
                        </button>
                    </div>
                </details>



            </div>
        </details>
        <div class="bg-white w-full h-full PageContents">
            <div id="title" class="flex items-center justify-center h-24 text-4xl text bg-[#f2f2f8]">
                Customer Rentals
            </div>
            <div class="bg-slate-50">
                <div class="border-b-2" >
                    <div class="flex my-2 ml-20">
                        <div class="w-max">
                            <div id="" class="searchContainer search relative">
                                <button onclick="search()" class="pl-1 pr-[.15rem] bg-[#dcdee6] hover:bg-[#caccd5] rounded-tl-[3px] rounded-bl-[3px]">
                                    <div class="searchIconOuter">
                                        <div class="searchIconInner">
                                            &#10991;
                                        </div>
                                    </div>
                                </button>
                                <input id="namesearch" type="text" placeholder="Search Customer Name" class="searchBox outline-none pl-2 border-y-2" maxlength='100'">
                                </input>
                                <div class=" absolute bg-white w-full h-max hidden border-2">
                            </div>
                        </div>
                    </div>
                    <div class="relative bg-white w-[80px]">
                        <details id="filterOptions" class="absolute w-max z-20">
                            <summary class="bg-white h-[30px] w-20 border-2">
                                <svg class="mr-1" xmlns="http://www.w3.org/2000/svg" width="16" height="24" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M1.5 1.5A.5.5 0 0 1 2 1h12a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-.128.334L10 8.692V13.5a.5.5 0 0 1-.342.474l-3 1A.5.5 0 0 1 6 14.5V8.692L1.628 3.834A.5.5 0 0 1 1.5 3.5v-2zm1 .5v1.308l4.372 4.858A.5.5 0 0 1 7 8.5v5.306l2-.666V8.5a.5.5 0 0 1 .128-.334L13.5 3.308V2h-11z" />
                                </svg>
                                Filter
                            </summary>
                            <form id="filters" onsubmit="event.preventDefault();filterData()" class="bg-white grid grid-cols-[10rem,1fr] w-96 gap-2 p-4 border-2">
                                <div class="text-xl pl-2">Field Name</div>
                                <div class="text-xl pl-2">Search Value</div>
                                <div class="col-span-2 filterOpts grid grid-cols-[10rem,1fr] gap-2">
                                    <select name="" class="filter border-2 outline-none">
                                        <option data-opt="1" value="" selected></option>
                                        <option data-opt="2" value="first_name">First Name</option>
                                        <option data-opt="3" value="surname">Surname</option>
                                        <option data-opt="4" value="phone_number">Phone Number</option>
                                        <option data-opt="5" value="email">Email</option>
                                    </select>
                                    <div class="w-full border-2">
                                        <input type="text" class="outline-none">
                                        <input disabled placeholder="First Name" required type="text" name="first_name" id="first_name3" maxlength="50" class="hidden outline-none">
                                        <input disabled placeholder="Surname" required type="text" name="surname" id="surname3" maxlength="50" class="hidden outline-none">
                                        <input disabled required type="tel" placeholder="1 123 123 1234" name="phone_number" id="phone_number3" pattern="(([0-9]-){0,1}[0-9]{3}[-\s][0-9]{0,3}[-\s][0-9]{4})" maxlength="14" class="hidden outline-none">
                                        <input disabled placeholder="name@example.com" required type="email" name="email" id="email3" class="hidden outline-none">
                                    </div>
                                </div>
                                <div class="col-span-2 filterOpts grid grid-cols-[10rem,1fr] gap-2">
                                    <select name="" class="filter border-2 outline-none">
                                        <option data-opt="1" value="" selected></option>
                                        <option data-opt="2" value="first_name">First Name</option>
                                        <option data-opt="3" value="surname">Surname</option>
                                        <option data-opt="4" value="phone_number">Phone Number</option>
                                        <option data-opt="5" value="email">Email</option>
                                    </select>
                                    <div class="w-full border-2">
                                        <input type="text" class="outline-none">
                                        <input disabled placeholder="First Name" required type="text" name="first_name" id="first_name3" maxlength="50" class="hidden outline-none">
                                        <input disabled placeholder="Surname" required type="text" name="surname" id="surname3" maxlength="50" class="hidden outline-none">
                                        <input disabled required type="tel" placeholder="1 123 123 1234" name="phone_number" id="phone_number3" pattern="(([0-9]-){0,1}[0-9]{3}[-\s][0-9]{0,3}[-\s][0-9]{4})" maxlength="14" class="hidden outline-none">
                                        <input disabled placeholder="name@example.com" required type="email" name="email" id="email3" class="hidden outline-none">
                                    </div>
                                </div>
                                <div class="col-span-2 filterOpts grid grid-cols-[10rem,1fr] gap-2">
                                    <select name="" class="filter border-2 outline-none">
                                        <option data-opt="1" value="" selected></option>
                                        <option data-opt="2" value="first_name">First Name</option>
                                        <option data-opt="3" value="surname">Surname</option>
                                        <option data-opt="4" value="phone_number">Phone Number</option>
                                        <option data-opt="5" value="email">Email</option>
                                    </select>
                                    <div class="w-full border-2">
                                        <input type="text" class="outline-none">
                                        <input disabled placeholder="First Name" required type="text" name="first_name" id="first_name3" maxlength="50" class="hidden outline-none">
                                        <input disabled placeholder="Surname" required type="text" name="surname" id="surname3" maxlength="50" class="hidden outline-none">
                                        <input disabled required type="tel" placeholder="1 123 123 1234" name="phone_number" id="phone_number3" pattern="(([0-9]-){0,1}[0-9]{3}[-\s][0-9]{0,3}[-\s][0-9]{4})" maxlength="14" class="hidden outline-none">
                                        <input disabled placeholder="name@example.com" required type="email" name="email" id="email3" class="hidden outline-none">
                                    </div>
                                </div>
                                <div class="col-span-2 filterOpts grid grid-cols-[10rem,1fr] gap-2">
                                    <select name="" class="filter border-2 outline-none">
                                        <option data-opt="1" value="" selected></option>
                                        <option data-opt="2" value="first_name">First Name</option>
                                        <option data-opt="3" value="surname">Surname</option>
                                        <option data-opt="4" value="phone_number">Phone Number</option>
                                        <option data-opt="5" value="email">Email</option>
                                    </select>
                                    <div class="w-full border-2">
                                        <input type="text" class="outline-none">
                                        <input disabled placeholder="First Name" required type="text" name="first_name" id="first_name3" maxlength="50" class="hidden outline-none">
                                        <input disabled placeholder="Surname" required type="text" name="surname" id="surname3" maxlength="50" class="hidden outline-none">
                                        <input disabled required type="tel" placeholder="1 123 123 1234" name="phone_number" id="phone_number3" pattern="(([0-9]-){0,1}[0-9]{3}[-\s][0-9]{0,3}[-\s][0-9]{4})" maxlength="14" class="hidden outline-none">
                                        <input disabled placeholder="name@example.com" required type="email" name="email" id="email3" class="hidden outline-none">
                                    </div>
                                </div>
                                <div class="col-span-2 flex gap-2">
                                    <input type="submit" style="padding: .5rem 1rem;" class="text-center bg-violet-400 hover:bg-[#8e72e1] text-white font-semibold border rounded shadow" value="Apply Filters"></input>
                                    <input onclick="document.getElementById('filterOptions').removeAttribute('open')" type="button" style="padding: .5rem 1rem;" class="text-center bg-violet-400 hover:bg-[#8e72e1] text-white font-semibold border rounded shadow" value="Cancel"></input>
                                </div>
                            </form>
                            <script>

                                function filterData() {

                                    let params = {
                                        table: "customers",
                                        default: null,
                                        options: {}
                                    }

                                    document.querySelectorAll("#filters select").forEach(filter => {
                                        let index = null;
                                        let inputs = filter.parentElement.querySelectorAll("input");

                                        if (filter.value == "first_name")
                                            index = 1
                                        else if (filter.value == "surname")
                                            index = 2
                                        else if (filter.value == "email")
                                            index = 4
                                        else if (filter.value == "phone_number")
                                            index = 3
                                        else
                                            index = null;
                                        if (index)
                                            params.options[filter.value] = inputs[index].value

                                    })

                                    if (Object.hasOwn(params.options, "phone_number"))
                                        params.options.phone_number = params.options.phone_number.replaceAll(" ", "-")

                                    if (Object.keys(params.options).length == 0)
                                        return false;

                                    fetch('rentals', {
                                        method: 'POST',
                                        body: JSON.stringify({ func: "Query", params: params }),
                                    }).then((res) => res.json())
                                        .then((results) => choose(results))

                                    document.getElementById('filterOptions').removeAttribute('open')

                                    return false;
                                }

                                document.querySelectorAll("#filters select").forEach(opt => {
                                    opt.addEventListener('change', (event) => {
                                        let index = null;

                                        if (event.srcElement.value == "")
                                            index = 0
                                        else if (event.srcElement.value == "first_name")
                                            index = 1
                                        else if (event.srcElement.value == "surname")
                                            index = 2
                                        else if (event.srcElement.value == "email")
                                            index = 4
                                        else if (event.srcElement.value == "phone_number")
                                            index = 3

                                        let inputs = event.srcElement.parentElement.querySelector("div")
                                        inputs = inputs.querySelectorAll("input")
                                        inputs.forEach(input => {
                                            input.style.display = "none";
                                            input.disabled = true
                                        })

                                        inputs[index].style.display = "unset"
                                        inputs[index].disabled = false

                                    })
                                })
                            </script>
                        </details>
                    </div>
                   
                </div>
                </div>
                <div>
                    <table>
                        <thead>
                            <tr>
                                <th>Vehicle License Plate</th>
                                <th>lend Date</th>
                                <th>Return Date</th>
                                <th>Returned Date</th>
                                <th>Lend Condition</th>
                                <th>Return Condition</th>
                                <th>Extra Charges</th>
                                <th>Rental Rate</th>
                                <th>Rental Fee</th>
                            </tr>
                        </thead>
                        <tbody id="rentalInfo">

                        </tbody>
                    </table>
                </div>
            </div>
        </div>


        <div id="popup" class="hidden absolute z-20 top-0  h-full w-full backdrop-blur-sm bg-white/10">
            <div class="bg-white overflow-hidden rounded-lg absolute top-0 bottom-0 right-0 left-0 m-auto min-w-[23rem] max-w-max h-max max-h-[65vh] grid grid-rows-[min-content,1fr,min-content] border-2">
                <div class="text-2xl text-center relative pb-1 p-3 pl-4">
                    <span id="mtitle" class="text-2xl">Offerred Vehicles</span>
                    <button id="popupclick" title="Close Modal" onclick="document.getElementById('popup').style.display = ''" class="absolute text-base font-medium right-3 top-3">
                        &#x26CC;
                    </button>
                </div>
                <div id="mcontents" class="mx-3 mt-1 border-t-2 p-1 pb-4 overflow-y-auto">
                    stuff
                </div>
                <div class="flex justify-end pr-4">
                    <button class="bg-violet-400 hover:bg-[#8e72e1] text-white font-semibold py-2 px-4 border  rounded shadow my-2 w-24" onclick="document.getElementById('popup').style.display = ''">Dismiss</button>
                </div>
            </div>
        </div>

    </div>

    <script>

        function select_(event) {
            document.getElementById("popupclick").click();
            let params = {table:"rentals",options:{customer_id:event.srcElement.parentElement.dataset.id}}


            fetch('rentals', {
                method: 'POST',
                body: JSON.stringify({ func: "Query", params: params }),
            }).then((res) => res.json())
                .then((results) =>{
                        loadData(results)
                })
            
        }


        function loadData(results){
            console.log(results)

            let tb = document.getElementById("rentalInfo");
            let today = new Date();

            results.forEach(rental=>{

                color = undefined;

                let rd = new Date(rental.return_date);
                if (rental.returned_date == "null" || !rental.returned_date) {
                    if (rd < today) {
                        color = `style="color:rgb(244 63 94)"`
                        rental.returned_date = "Overdue"

                    } else if (new Date(rental.lend_date) > today) {
                        color = `style="color:rgb(52 211 153)"`
                        rental.returned_date = "Future Rental"
                    } else {
                        color = `style="color:rgb(52 211 153)"`
                        rental.returned_date = "Ongoing"
                    }

                } else if (rd < new Date(rental.returned_date)) {
                    color = `style="color:rgb(244 63 94)"`
                }


                tb.innerHTML+=`
                    <tr>
                        <td>${rental.vehicle_id}</td>
                        <td>${rental.lend_date}</td>
                        <td>${rental.return_date}</td>
                        <td ${color}>${rental.returned_date}</td>
                        <td>${rental.lent_condition}</td>
                        <td>${rental.return_condition}</td>
                        <td>${rental.extra_charges}</td>
                        <td>${rental.rental_rate}</td>
                        <td>${rental.rental_fee}</td>
                    </tr>
                `
            })



        }

        function popup(title, innerhtml, error) {
            let modal = document.getElementById("popup");
            modal.querySelector("#mtitle").innerHTML = title;
            modal.querySelector("#mcontents").innerHTML = innerhtml;
            document.getElementById("popup").style.display = "block";

            if (error)
                document.querySelector("#mcontents").style.borderColor = "rgb(244 63 94)"
            else
                document.querySelector("#mcontents").style.borderColor = ""

        }



        function choose(results) {
         if(results.length){
                let temp = `<table>
                                <thead>
                                    <tr>
                                        <th>Customer Name</th>
                                        <th>Email</th>
                                        <th>Phone Number</th>
                                        <th>License Number</th>
                                        <th>Address</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `
                results.forEach(customer=>{
                    temp+=`
                    <tr data-id=${customer.customer_id} onclick="select_(event)">
                        <td>${customer.first_name} ${customer.surname}</td>
                        <td>${customer.email}</td>
                        <td>${customer.drivers_license}</td>
                        <td>${customer.phone_number}</td>
                        <td>${customer.address}</td>
                    </tr>
                    `
                })

                temp += `</body></table>`;

                popup("Select A Customer",temp);

            }else{
                popup("No Data Found", `<div style='width:100%;padding-top:.5rem;padding-left:4px;font-size:1.25rem'>The Specified Customer Has No Rentals <br> Please Choose Another Customer</div>`)
            }
        }

        function search() {
            let params = {
                table: "customers",
                default: null,
                options: {}
            }

            let names = document.getElementById("namesearch").value.trim().split(" ", 2)

            if (names.length > 1) {
                params.options.first_name = names[0]
                params.options.surname = names[1]
            } else if (names.length == 1 && names[0]) {
                params.options.first_name = names[0]
            }

            if (Object.keys(params.options).length == 0)
                return false;

            fetch('rentals', {
                method: 'POST',
                body: JSON.stringify({ func: "Query", params: params }),
            }).then((res) => res.json())
                .then((results) => choose(results))

        }

    </script>



</body>

</html>